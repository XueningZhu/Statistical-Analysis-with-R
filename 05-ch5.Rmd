# 第5章：参数估计与假设检验 {#ch5}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, cache = T)
```

```{r message=FALSE,warning=FALSE}
### 数据准备 ###
# 清空工作空间
rm(list = ls())
```

## 总体、样本和样本量

## 参数估计

### 矩估计

#### 任务一：电池续航时间

2030年，苹果公司发布新一代手机iPhone SSR。该手机声称续航能力比上一版本（20小时）有较大提升。为调查市面上售卖的苹果手机是否满足这样的续航能力，我们收集并测试了50部苹果手机的续航时间，得到如下数据。假设苹果手机的续航时间服从指数分布，那么使用矩估计推断该苹果手机的平均续航时间是多久？

```{r}
# 例1
battery <- c(20.2,19.4,18.6,18.2,19.8,21.4,18.2,19.8,17.4,19.4,21.4,19,19,17,
             23,22.6,21.4,20.2,22.6,20.2,21.4,20.2,18.2,20.2,19,19.8,19.8,20.6,
             20.6,18.6,19,21.4,20.6,21.8,19.4,19.8,21.8,19.4,17.4,20.2,19.8,17.8,
             17.4,19.8,20.2,19,20.2,18.2,21,19.8)
mean(battery)  # 样本均值
```

答：可以计算得到以上50部手机的续航时间均值为19.824。

#### 任务二：正态总体参数估计

使用模拟的方法，估计来自于正态总体的均值$\mu$和方差$\sigma^2$。

```{r}
# 例2
set.seed(123)
data1 <- rnorm(n = 1000, mean = 5, sd = 2)  # 产生服从正态分布的随机数
mean(data1)  # 样本均值
var(data1)  # 样本方差
```

产生1000个服从$N(5,4)$的随机数，分别求这个样本的一阶原点矩（均值）和二阶中心矩（方差），作为总体均值和方差的估计。结果显示，对总体均值的估计为5.03，总体方差的估计为3.93。

### 极大似然估计

#### 任务三：苹果手机续航时间

假设苹果公司发布的新一代手机iPhone SSR续航时间是服从正态分布$N(\mu, \sigma^2)$，其中，$\mu$ 是总体均值，$\sigma^2$ 是总体方差。请根据案例数据中的50个续航时间样本使用最大似然估计的方法，估计总体的均值和方差。

```{r}
cat('苹果手机电池续航数据为: ', battery, '\n')
# 续航时间均值的极大似然估计是
mu_mle <- mean(battery)
# 续航时间方差的极大似然估计是
sigma_mle <- mean((battery - mean(battery)) ** 2)
cat('均值的最大似然估计值是: ', mu_mle, 
    '方差的最大似然估计值是: ', sigma_mle, '\n')
```

根据极大似然估计的方法，可以得到手机电池续航时间均值的最大似然估计值是19.824 方差的最大似然估计值是1.948224。

#### 任务四：均匀分布总体参数估计

设$x_1, ..., x_n$是从均匀分布总体 $U(0,\theta)$ 中抽出的一个样本，观测值如下：

6.0627 9.3764 2.6435 3.8009 8.0748 9.7808 9.5793 7.6273 5.0965 0.6448 

6.4357 9.1591 0.9523 2.9537 7.6993 2.5589 5.179 6.7785 1.4723 7.0053

试求解$\theta$的最大似然估计。

```{r}
set.seed(6)
theta = 10
# 生成的样本是
samples = runif(n=20, 0, theta)
samples = round(samples, 4)
cat('样本是: ', samples, '\n')

# theta 的最大似然估计值是
theta_mle = max(samples)
cat('theta的最大似然估计值是: ', theta_mle, '\n')
```

在此案例数据中，均匀分布总体的参数$\theta$极大似然估计值是9.7808。

### 区间估计

#### 任务五：手机续航时间的区间估计

已知上述案例中苹果手机的续航时间服从正态分布，其标准差为2小时，试求该型号手机续航时间的0.95置信区间。可以直接使用`z.test()`函数，也可以根据公式进行计算。

```{r warning=F, message=F}
# 例5：续航时间区间估计
# 方法一：按照公式计算
mu <- mean(battery)
sigma <- 2
n <- 50
spread <- qnorm(1-0.05/2, 0, 1) * sigma / sqrt(n)
cat(sprintf('续航时间的置信区间是: [%s, %s]', 
            round(mu - spread, 4),
            round(mu + spread, 4), '\n'))

# 方法二：使用z.test()计算
library(BSDA)
interval_1 <- z.test(battery, sigma.x = sigma, conf.level = 0.95)$conf.int
cat(sprintf('续航时间的置信区间是: [%s, %s]', 
            round(interval_1[1], 4),
            round(interval_1[2], 4), '\n'))
```

无论按照公式计算，还是直接使用R中自带的函数，续航时间的置信区间估计都是 [19.2696, 20.3784]。

#### 任务六：红楼梦词频区间估计

为了了解红楼梦在前、中、后三个部分对虚词使用的习惯，拟对不同章节的“之”字词频进行分析。假设小说对文言虚词的使用频率服从正态分布，试求第41-80回和第81-120回虚词“之”词频差的0.95置信区间。（注意：请区分两总体方差是否相等两种情况讨论）

```{r}
# 例6
wenyan <- read.csv("./data/红楼梦虚词词频统计.csv", stringsAsFactors = F, fileEncoding = "utf-8")
freqx <- wenyan$`之`[41:80]
freqy <- wenyan$`之`[81:120]
m = length(freqx); n = length(freqy)
u_x = mean(freqx); u_y = mean(freqy)
s_x = sd(freqx); s_y = sd(freqy)

## (1) 如果两部分数据的方差相等
## 方法一：使用公式计算
s_w = sqrt(((m-1)*s_x^2 + (n-1)*s_y^2) / (m+n-2))
spread = qt(1 - 0.05/2, m+n-2) * s_w * sqrt(1/m + 1/n)
cat(sprintf('如果两部分数据方差相等，第41-80回和第81-120回“之”词频差的置信区间是: [%s, %s]', 
            round(u_x - u_y - spread, 4),
            round(u_x - u_y + spread, 4), '\n'))

## 方法二：使用t.test()计算
interval_3 <- t.test(freqx, freqy, var.equal = T, conf.level = 0.95)$conf.int
cat(sprintf('如果两部分数据方差相等，第41-80回和第81-120回“之”词频差的置信区间是: [%s, %s]', 
            round(interval_3[1], 4),
            round(interval_3[2], 4), '\n'))

## (2) 如果两部分数据方差不等
## 方法一：使用公式计算
s_o = sqrt(s_x^2 / m + s_y^2 / n)
freedom = s_o^4 / (s_x^4/(m^2 * (m-1)) + s_y^4/(n^2 * (n-1)))
freedom = round(freedom, 0)
spread = qt(1 - 0.05/2, freedom) * s_o
cat(sprintf('如果两部分数据方差不等，第41-80回和第81-120回“之”词频差的置信区间是: [%s, %s]', 
            round(u_x - u_y - spread, 4),
            round(u_x - u_y + spread, 4), '\n'))

## 方法二：使用t.test()计算
interval_4 <- t.test(freqx, freqy, var.equal = F, conf.level = 0.95)$conf.int
cat(sprintf('如果两部分数据方差不等，第41-80回和第81-120回“之”词频差的置信区间是: [%s, %s]', 
            round(interval_4[1], 4),
            round(interval_4[2], 4), '\n'))
```

如果两部分数据方差相等，第41-80回和第81-120回“之”词频差的置信区间是: [8.9824, 20.3176]；如果两部分数据方差不等，第41-80回和第81-120回“之”词频差的置信区间是: [8.9291, 20.3709]。在两总体方差不等的情况中，对t统计量的自由度做了近似处理，因此两种方法计算得到的结果稍有不同。

## 假设检验

#### 任务一：苹果手机续航时间

假设苹果手机SSR的续航时间服从正态分布$N(\theta, 0.8^2)$，其中$\theta$的设计值不低于20小时。根据案例引入中给出的50次抽样检测数据，判断该苹果手机的续航时间是否满足出厂设计的要求？除了使用公式计算p值的方法。对于这个问题，你还可以尝试使用`BSDA`包中的`z.test()`和`t.test()`函数（假设总体方差未知的情况）进行检验。

```{r}
battery <- c(20.2,19.4,18.6,18.2,19.8,21.4,18.2,19.8,17.4,19.4,21.4,19,19,17,
             23,22.6,21.4,20.2,22.6,20.2,21.4,20.2,18.2,20.2,19,19.8,19.8,20.6,
             20.6,18.6,19,21.4,20.6,21.8,19.4,19.8,21.8,19.4,17.4,20.2,19.8,17.8,
             17.4,19.8,20.2,19,20.2,18.2,21,19.8)
a <- 20
s <- 0.8
n <- 50
xbar <- mean(battery)
p_value <- pnorm(xbar, mean = a, sd = s/sqrt(n))
print(paste0("检验的p值为", round(p_value, 4)))
```

检验的p值为0.0599。	当$\alpha<0.0599$时，$z_\alpha<-1.56$，由于拒绝域为$W=\{z≤z_\alpha\}$，于是观测值$z=-1.56$不在拒绝域里，应接受原假设；
	当$\alpha≥0.0599$时，$z_\alpha≥-1.56$，由于拒绝域为$W=\{z≤z_\alpha\}$，于是观测值$z=-1.56$落在拒绝域里，应拒绝原假设；
由此可以看出，0.0599是能用观测值$z=-1.56$做出“拒绝$H_0$”的最小的显著性水平。

```{r}
# 使用检验函数`z.test()`和`t.test()`
library(BSDA)
# 单样本均值的单边检验
z.test(battery, mu = 20, sigma.x = 0.8, alternative = "less", conf.level = 0.95)
# 单样本均值的单边检验（方差未知）
t.test(battery, mu = 20, alternative = "less", conf.level = 0.95)
```

使用R中自带的检验函数，在总体方差已知的情况下，检验p值为0.0599；而在总体方差未知的情况下，检验的p值为0.1909。

#### 任务二：红楼梦虚词频率

假设小说对文言虚词的使用频率服从正态分布，且词频方差在不同阶段保持不变，在显著性水平$\alpha=0.05$下，尝试判断41-80回中“亦”使用的频数均值是否比81-120回中高？ 

```{r}
# 红楼梦
wenyan <- read.csv("./data/红楼梦虚词词频统计.csv", stringsAsFactors = F, fileEncoding = "UTF-8")
freqx <- wenyan$`亦`[41:80]
freqy <- wenyan$`亦`[81:120]
t.test(freqx, freqy, alternative = "greater", var.equal = T, conf.level = 0.95)
```

由于检验的P值小于显著性水平0.05，因此拒绝原假设，认为41-80回“亦”使用的平均数量显著高于81-120回，后期语言向白话文靠拢。

#### 任务三：狗熊制药成对样本检验

假设狗熊会开了一个狗熊制药公司，专业研究减肥药。如果这个药品要在美国市场上合法上市，必须有美国食品药品管理局（FDA）的批准。为此，FDA对使用该药物的受试者做了一组试验，记录了其在使用减肥药前后的体重（单位：kg）。试验的数据分别为

|     受试者编号    |     1     |     2     |     3     |     4     |     5     |     6     |     7     |     8     |     9     |     10       |
|-------------------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|-----------|--------------|
|   服用药物前的体重x  |     43    |     55    |     49    |     62    |     59    |     49    |     57    |     54    |     55    |     48       |
|   服用药物后的体重y  |     50    |     59    |     55    |     60    |     58    |     54    |     56    |     53    |     61    |     51       |
|差 d = x-y |     -7    |     -4    |     -6    |     2     |     1     |     -5    |     1     |     1     |     -6    |     -   3    |


的狗熊制药案例数据中，假定受试者的体重数据服从正态分布，试问：试验前后的受试者体重在显著性水平$\alpha=0.05$上有无差异？

```{r}
# 成对数据检验
x <- c(43,55,49,62,59,49,57,54,55,48)
y <- c(50,59,55,60,58,54,56,53,61,51)
# 成对数据t检验
t.test(x, y, alternative = "two.sided", paired = T, var.equal = F, conf.level = 0.95)
```

检验的p值为0.0435，故应拒绝原假设$H_0:\mu=0$，即可认为试验前后的受试者体重有显著差异。进一步，平均含量差值的估计量为$\hat \mu = \bar x - \bar y = -2.6$，可见服用药物后的体重要高于服用药物前的体重。
